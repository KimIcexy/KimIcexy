<!DOCTYPE html>
<html>
<head>
  <title>Web App Chỉnh sửa ảnh</title>
  <style>
    #canvas {
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <input type="file" id="imageInput">
  <canvas id="canvas"></canvas>
  <div>
    <label for="text">Văn bản:</label>
    <input type="text" id="text" placeholder="Nhập văn bản">
  </div>
  <div>
    <label for="textColor">Màu sắc chữ:</label>
    <input type="color" id="textColor" value="#000000">
  </div>
  <div>
    <label for="fontSize">Kích thước chữ:</label>
    <input type="number" id="fontSize" min="1" max="100" step="1" value="20">
  </div>
  <button onclick="addText()">Thêm chữ</button>
  <button onclick="clearText()">Xóa văn bản</button>

  <script>
    // Khởi tạo các biến và context của canvas
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    var imageInput = document.getElementById('imageInput');
    var img = new Image();

    // Sự kiện khi người dùng chọn ảnh
    imageInput.addEventListener('change', function(e) {
      var file = e.target.files[0];
      var reader = new FileReader();
      reader.onload = function(event) {
        img.onload = function() {
          // Đưa ảnh về kích thước phù hợp với khung hình
          var aspectRatio = img.width / img.height;
          var maxWidth = canvas.width;
          var maxHeight = canvas.height;

          if (aspectRatio > 1) {
            canvas.width = maxWidth;
            canvas.height = maxWidth / aspectRatio;
          } else {
            canvas.width = maxHeight * aspectRatio;
            canvas.height = maxHeight;
          }

          // Vẽ ảnh lên canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          drawTextElements();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Mảng lưu trữ thông tin văn bản
    var textElements = [];
    var selectedTextIndex = -1;
    var isDragging = false;
    var prevX;
    var prevY;

    // Hàm vẽ tất cả các văn bản lên canvas
    function drawTextElements() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      textElements.forEach(function(textElement, index) {
        ctx.font = textElement.fontSize + 'px Arial';
        ctx.fillStyle = textElement.color;
        ctx.fillText(textElement.text, textElement.x, textElement.y);

                // Đánh dấu văn bản được chọn
                if (index === selectedTextIndex) {
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(
                      textElement.x,
                      textElement.y - textElement.fontSize,
                      ctx.measureText(textElement.text).width,
                      textElement.fontSize
                    );
                  }
                });
              }
          
              // Hàm thêm văn bản vào canvas
              function addText() {
                var text = document.getElementById('text').value;
                var textColor = document.getElementById('textColor').value;
                var fontSize = parseInt(document.getElementById('fontSize').value);
          
                var textElement = {
                  text: text,
                  color: textColor,
                  fontSize: fontSize,
                  x: canvas.width / 2,
                  y: canvas.height / 2
                };
          
                textElements.push(textElement);
                drawTextElements();
              }
          
              // Hàm xóa văn bản khỏi canvas
              function clearText() {
                textElements = [];
                drawTextElements();
              }
          
              // Sự kiện khi chuột được nhấn xuống trên canvas
              canvas.addEventListener('mousedown', function(e) {
                var x = e.offsetX;
                var y = e.offsetY;
          
                textElements.forEach(function(textElement, index) {
                  var textWidth = ctx.measureText(textElement.text).width;
                  var textHeight = textElement.fontSize;
          
                  // Kiểm tra xem chuột có nằm trong vùng chữ không
                  if (
                    x >= textElement.x &&
                    x <= textElement.x + textWidth &&
                    y >= textElement.y - textHeight &&
                    y <= textElement.y
                  ) {
                    selectedTextIndex = index;
                    isDragging = true;
                    prevX = x;
                    prevY = y;
                  }
                });
          
                drawTextElements();
              });
          
              // Sự kiện khi chuột được di chuyển trên canvas
              canvas.addEventListener('mousemove', function(e) {
                if (isDragging) {
                  var x = e.offsetX;
                  var y = e.offsetY;
          
                  var deltaX = x - prevX;
                  var deltaY = y - prevY;
          
                  textElements[selectedTextIndex].x += deltaX;
                  textElements[selectedTextIndex].y += deltaY;
          
                  prevX = x;
                  prevY = y;
          
                  drawTextElements();
                }
              });
          
              // Sự kiện khi chuột được nhả ra trên canvas
              canvas.addEventListener('mouseup', function() {
                isDragging = false;
              });
          
              // Vẽ các văn bản ban đầu lên canvas
              drawTextElements();
            </script>
          </body>
          </html>
          
